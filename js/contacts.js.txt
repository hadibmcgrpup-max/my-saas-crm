/**
 * Contacts Module Logic
 */

// Helper to fill the Account dropdown from storage
const populateAccountDropdown = () => {
    const accounts = CRMStorage.getData('accounts');
    const dropdown = document.getElementById('conAccount');
    if (!dropdown) return;

    dropdown.innerHTML = accounts.map(acc => 
        `<option value="${acc.name}">${acc.name}</option>`
    ).join('') || '<option disabled selected value="">Please create an Account first</option>';
};

document.addEventListener('DOMContentLoaded', () => {
    loadContacts();

    // Handle Form Submission
    const contactForm = document.getElementById('contactForm');
    if (contactForm) {
        contactForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const contactData = {
                id: document.getElementById('conId').value || null,
                name: document.getElementById('conName').value,
                account: document.getElementById('conAccount').value,
                email: document.getElementById('conEmail').value
            };
            CRMStorage.saveRecord('contacts', contactData);
            closeContactModal();
            loadContacts();
        });
    }
});

function loadContacts() {
    const contacts = CRMStorage.getData('contacts');
    const tableBody = document.getElementById('contactsTableBody');
    if (!tableBody) return;

    tableBody.innerHTML = contacts.map(con => `
        <tr class="hover:bg-gray-50 border-b border-gray-100">
            <td class="p-4 font-medium text-gray-800">${con.name}</td>
            <td class="p-4 text-gray-600">
                <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-semibold">
                    <i class="fas fa-building mr-1"></i> ${con.account}
                </span>
            </td>
            <td class="p-4 text-gray-600">${con.email}</td>
            <td class="p-4 text-right">
                <button onclick="editContact('${con.id}')" class="text-blue-500 hover:text-blue-700 mx-2">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteContact('${con.id}')" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Modal Controls
window.openContactModal = () => {
    populateAccountDropdown();
    const form = document.getElementById('contactForm');
    if (form) form.reset();
    document.getElementById('conId').value = "";
    document.getElementById('contactModal').classList.remove('hidden');
};

window.closeContactModal = () => {
    document.getElementById('contactModal').classList.add('hidden');
};

window.editContact = (id) => {
    const contacts = CRMStorage.getData('contacts');
    const con = contacts.find(c => c.id === id);
    if (!con) return;

    window.openContactModal(); // Ensure dropdown is populated and modal is visible
    document.getElementById('conId').value = con.id;
    document.getElementById('conName').value = con.name;
    document.getElementById('conAccount').value = con.account;
    document.getElementById('conEmail').value = con.email;
};

window.deleteContact = (id) => {
    if (confirm('Are you sure you want to delete this contact?')) {
        CRMStorage.deleteRecord('contacts', id);
        loadContacts();
    }
};