/**
 * Leads Module Logic
 */
document.addEventListener('DOMContentLoaded', () => {
    loadLeads();

    // Handle Form Submission
    document.getElementById('leadForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const leadData = {
            id: document.getElementById('leadId').value || null,
            name: document.getElementById('leadName').value,
            company: document.getElementById('leadCompany').value,
            email: document.getElementById('leadEmail').value,
            phone: document.getElementById('leadPhone').value,
            source: document.getElementById('leadSource').value,
            status: document.getElementById('leadStatus').value
        };

        CRMStorage.saveRecord('leads', leadData);
        closeLeadModal();
        loadLeads();
    });
});

// Load and Render Table
function loadLeads() {
    const leads = CRMStorage.getData('leads');
    renderLeadsTable(leads);
}

function renderLeadsTable(leads) {
    const tableBody = document.getElementById('leadsTableBody');
    tableBody.innerHTML = leads.map(lead => `
        <tr class="hover:bg-gray-50 transition">
            <td class="p-4 font-medium text-gray-800">${lead.name}</td>
            <td class="p-4 text-gray-600">${lead.company}</td>
            <td class="p-4">
                <div class="text-sm font-semibold text-gray-700">${lead.email}</div>
                <div class="text-xs text-gray-400">${lead.phone}</div>
            </td>
            <td class="p-4">
                <span class="px-3 py-1 rounded-full text-xs font-bold ${getStatusColor(lead.status)}">
                    ${lead.status}
                </span>
            </td>
            <td class="p-4 text-right">
                <button onclick="editLead('${lead.id}')" class="text-blue-500 hover:text-blue-700 mx-2"><i class="fas fa-edit"></i></button>
                <button onclick="deleteLead('${lead.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `).join('');
}

// Helper: Status Colors
function getStatusColor(status) {
    const colors = {
        'New': 'bg-blue-100 text-blue-700',
        'Contacted': 'bg-yellow-100 text-yellow-700',
        'Qualified': 'bg-green-100 text-green-700',
        'Converted': 'bg-purple-100 text-purple-700',
        'Lost': 'bg-red-100 text-red-700'
    };
    return colors[status] || 'bg-gray-100 text-gray-700';
}

// Modal Controls
function openLeadModal() {
    document.getElementById('modalTitle').innerText = "Add New Lead";
    document.getElementById('leadForm').reset();
    document.getElementById('leadId').value = "";
    document.getElementById('leadModal').classList.remove('hidden');
}

function closeLeadModal() {
    document.getElementById('leadModal').classList.add('hidden');
}

// Edit/Delete actions
window.editLead = (id) => {
    const leads = CRMStorage.getData('leads');
    const lead = leads.find(l => l.id === id);
    if (!lead) return;

    document.getElementById('modalTitle').innerText = "Edit Lead";
    document.getElementById('leadId').value = lead.id;
    document.getElementById('leadName').value = lead.name;
    document.getElementById('leadCompany').value = lead.company;
    document.getElementById('leadEmail').value = lead.email;
    document.getElementById('leadPhone').value = lead.phone;
    document.getElementById('leadSource').value = lead.source;
    document.getElementById('leadStatus').value = lead.status;
    
    document.getElementById('leadModal').classList.remove('hidden');
};

window.deleteLead = (id) => {
    if (confirm('Are you sure you want to delete this lead?')) {
        CRMStorage.deleteRecord('leads', id);
        loadLeads();
    }
};

// Filter Logic
window.filterLeads = () => {
    const search = document.getElementById('leadSearch').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    const leads = CRMStorage.getData('leads');

    const filtered = leads.filter(l => {
        const matchesSearch = l.name.toLowerCase().includes(search) || l.company.toLowerCase().includes(search);
        const matchesStatus = status === "" || l.status === status;
        return matchesSearch && matchesStatus;
    });

    renderLeadsTable(filtered);
};